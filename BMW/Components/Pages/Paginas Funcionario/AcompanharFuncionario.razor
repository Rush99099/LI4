@page "/funcionario/gestor-encomendas/acompanhar/{id:int}"
@using BMW.Data.Data
@using BMW.Data
@using BMW.Data.Models
@inject UserState UserState
@inject NavigationManager NavigationManager

<PageTitle>Acompanhar Encomenda</PageTitle>

<TableLayout 
    UserName="@UserState.UserName"
    UserRole="Funcion√°rio"
    Button1Text="Gest√£o de Encomendas"
    Button1Href="/funcionario/gestor-encomendas"
    Button1Icon="üì¶"
    Button2Text="Relat√≥rios"
    Button2Href="/funcionario/relatorios"
    Button2Icon="üìÑ"
    Title="Acompanhar Encomenda">

    <div class="encomenda-container">
        <div class="encomenda-detalhes">
            <h3 class="encomenda-titulo">Encomenda #@Id</h3>
            <p><strong>Ve√≠culo:</strong> @Modelo</p>
            <p><strong>Fase de Montagem Atual:</strong> (@FaseAtual.Ordem/15) - @FaseAtual.Descricao</p>
            <p><strong>Tempo Estimado Atual:</strong> @FaseAtual.TempoExecucaoExpectavel</p>
        </div>

        <div class="fase-progresso">
            <h4>Progresso Geral:</h4>
            <div class="progresso-barra">
                <div class="progresso-preenchido" style="width: @ProgressoPercentual%;"></div>
            </div>
            <p>@ProgressoPercentual% Completo</p>
        </div>

        <div class="fase-imagem">
            <img src="@FaseImagem" alt="Fase Atual - @FaseAtual.Descricao" />
        </div>

        <div class="encomenda-acoes">
            <button class="btn" @onclick="RegistarFase">Registar Fase de Montagem</button>
            <button class="btn" @onclick="RegistarAlerta">Registar Alerta</button>
        </div>
    </div>
</TableLayout>

@code {
    [Parameter]
    public int Id { get; set; }

    private string Modelo = string.Empty;
    private FaseDeMontagem FaseAtual = new();
    private int ProgressoPercentual = 0;
    private string FaseImagem = string.Empty;

    protected override void OnInitialized()
    {
        try
        {
            var facade = BMWFacade.GetInstance();
            var encomenda = facade.GetEncomendaById(Id);
            if (encomenda == null) throw new Exception("Encomenda n√£o encontrada.");
    
            Modelo = facade.GetVeiculoById(encomenda.IdVeiculo).Modelo;
    
            var progresso = facade.GetProgresso(Id);
            if (progresso.Any())
            {
                var ultimaFase = progresso.OrderByDescending(p => p.IdFase).First();
                FaseAtual = facade.GetFaseDeMontagemById(ultimaFase.IdFase);
                ProgressoPercentual = (int)((double)FaseAtual.Ordem / 15 * 100);
            }
            else
            {
                FaseAtual = facade.GetFaseDeMontagemById(1);
                ProgressoPercentual = 0;
            }
    
            FaseImagem = $"images/fases/{FaseAtual.Ordem}.png";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar detalhes da encomenda: {ex.Message}");
        }
    }

    private void RegistarFase()
    {
        // Implementa√ß√£o do registo da pr√≥xima fase
        Console.WriteLine("Registar Fase acionado.");
    }

    private void RegistarAlerta()
    {
        // Implementa√ß√£o do registo de alerta
        Console.WriteLine("Registar Alerta acionado.");
    }
}

<style>
    .encomenda-container {
        padding: 20px;
        background-color: #ffffff;
        border-radius: 10px;
        color: #121212;
        text-align: center;
    }

    .encomenda-detalhes {
        margin-bottom: 20px;
    }

    .fase-progresso {
        margin: 20px 0;
    }

    .progresso-barra {
        height: 25px;
        width: 100%;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }

    .progresso-preenchido {
        height: 100%;
        background-color: #007bff;
        transition: width 0.3s ease;
    }

    .fase-imagem img {
        max-width: 100%;
        border-radius: 10px;
        margin: 20px 0;
    }

    .encomenda-acoes {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
    }

    .btn {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        font-size: 1rem;
        cursor: pointer;
    }

    .btn:hover {
        background-color: #0056b3;
    }
</style>
